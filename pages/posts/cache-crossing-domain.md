---
title: 缓存跨域
date: 2022/1/21 9:37:00
description: 一个同事遇到的奇怪跨域情况
tag: 跨域,缓存
author: Mowtwo
---

# 缓存跨域
今天早上，同事拿着练手的Vue项目来我，说是之前一直可以的Vue项目突然出现跨域问题，但是这个项目很久没有改过任何代理相关的配置，出现缓存跨域是很不正常的情况。  

## 排除配置错误可能
于是我很快加入了排错过程，按照之前的经验，我排查了配置，但是跟同事说的一样，代理的配置最早是我帮忙修改，一切正常，目前也没有任何更改。询问过其他同事，我自己也启动了项目进行相同代理的访问，但是依然一切正常。

## 排除Axios错误可能
由于无法从代理上寻找到问题，所以我开始怀疑axios，但是同事的axios配置是从另外一个同事那里复制，并且很久没有修改。配置的来源同事也是一切正常，我开始在axios的请求守卫response上面打断点，但是守卫的err上面只返回了一个没有任何body跟message的空对象。

## 清空缓存
无法从代码上下手，只能再次怀疑到缓存上，于是让同事快速清空了浏览器缓存。 
不过可以预见，基本上没有任何改变，依然是报了一个跨域问题。 
不过一个奇怪的现象很快被我注意到，那就是同事的代理是生效的，也就是确实的代理到了本地的地址，但是代理又被重定向回代理的源地址，然后从重定向的地址返回的一个跨域（实际上就是浏览器拦截了）。

而且我发现浏览器给出的一个跨域源也很诡异，正常情况下，跨域的源地址应该就是访问的源地址。比如：

> 我从127.0.0.1访问www.baidu.com的一个接口，因为跨域问题，浏览器报跨域

![image-20220121095235356](https://raw.githubusercontent.com/mowtwo/pic-go/main/markdown/image-20220121095235356.png)

跨域的来源应该就是访问的源地址本身，而同事的跨域还涉及到了一个完全没有任何关系的地址。

但是在排除了host问题后，这个问题几乎陷入了僵局。

## 意外解除跨域

问题本来一筹莫展，我打算再次从network内进行调试，因此我习惯性的打开了保留日志功能和禁用服务器缓存的设置。

但是就在这时诡异的事情发生了，跨域的问题消失了。我当时整个人都不好了，然后快速往回复现过程：

- 首先保留日志大概率不会是成功原因
- 禁用服务器缓存可能是成功的原因
- 我还把代理的地址从测试服修改到了线上服

当我把禁用缓存关闭后，发现依然可以正常访问，没有跨域出现。其实这里我心里有了一些答案，但是我还在疑惑出现问题的原因。

我将代理的地址切换回测试服务器，再次访问，跨域问题再现，我又一次打开禁用缓存，然后更诡异了，并没有生效？

不过我并没有放弃，再次将代理地址切换到线上服地址，但是并没有着急打开禁用缓存，果然跨域出现了，然后再次打开禁用缓存，服务又可以了。之后再关闭禁用，无论怎么启动都没有问题，因此可以推测出问题

- 测试服务器有缓存
- 测试服务器的缓存会造成跨域问题

虽然到现在为止，问题得到了解决，但是这个问题依然在困扰我，我还是要继续排查问题。

## 结尾

现在写下是为了记住问题，之后会尝试复现。而且因为刚入职，刚各种部门还没办法很好的对接，测试服务器是在测试手上，测试服务上部署了很多其他服务器，但是具体引起问题的原因无法排查，而且目前其他人没有出现问题，没办法向上提出问题，只能自己私下排查了。